{% extends "mobile/base.html" %}
{% block title %}Reggie Camera{% endblock %}

{% block head %}
<style>
    .mobile-shell { padding-bottom: 0; }
    .mobile-nav { display: none; }
    .mobile-content { padding: 0; overflow: hidden; }
    .mobile-header { position: absolute; top: 0; left: 0; right: 0; z-index: 100; background: linear-gradient(180deg, rgba(0,0,0,0.7), transparent); }
</style>
{% endblock %}

{% block content %}
<div class="video-fullscreen" id="video-container">
    <video id="video-feed" autoplay playsinline muted style="display: none;"></video>
    <img id="mjpeg-feed" src="" alt="Camera Feed" style="width: 100%; height: 100%; object-fit: contain; display: none;">

    <div id="camera-loading" style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000;">
        <div class="loading-spinner" style="width: 48px; height: 48px; margin-bottom: 16px;"></div>
        <div class="text-secondary">Connecting to camera...</div>
    </div>

    <div id="camera-error" style="position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; padding: 20px;">
        <div style="font-size: 3rem; margin-bottom: 16px;">&#128249;</div>
        <div class="text-primary" style="font-size: 1.1rem; margin-bottom: 8px;">Camera Unavailable</div>
        <div class="text-secondary text-center" style="margin-bottom: 20px;">Could not connect to video feed</div>
        <button class="btn btn-primary" onclick="retryCamera()">Retry</button>
    </div>

    <div class="video-overlay" id="video-overlay">
        <button class="btn btn-secondary btn-icon" onclick="window.location.href='/m/reggie'">&#10005;</button>
        <button class="btn btn-secondary btn-icon" onclick="toggleFullscreen()">&#9974;</button>
        <button class="btn btn-primary btn-icon" onclick="takeSnapshot()">&#128247;</button>
    </div>
</div>

<div id="snapshot-modal" style="position: fixed; inset: 0; z-index: 400; display: none; background: rgba(0, 0, 0, 0.9); flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
    <img id="snapshot-preview" src="" alt="Snapshot" style="max-width: 100%; max-height: 70vh; border-radius: var(--radius-lg);">
    <div class="flex gap-3 mt-4">
        <button class="btn btn-secondary" onclick="closeSnapshot()">Close</button>
        <button class="btn btn-primary" onclick="downloadSnapshot()">Save</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let videoEl, mjpegEl;

document.addEventListener('DOMContentLoaded', function() {
    videoEl = document.getElementById('video-feed');
    mjpegEl = document.getElementById('mjpeg-feed');
    initCamera();
});

async function initCamera() {
    try {
        mjpegEl.onload = () => { document.getElementById('camera-loading').style.display = 'none'; mjpegEl.style.display = 'block'; };
        mjpegEl.onerror = () => showError();
        mjpegEl.src = '/api/reggie/camera/stream';
        setTimeout(() => { if (document.getElementById('camera-loading').style.display !== 'none') showError(); }, 10000);
    } catch { showError(); }
}

function showError() { document.getElementById('camera-loading').style.display = 'none'; document.getElementById('camera-error').style.display = 'flex'; }
function retryCamera() { document.getElementById('camera-error').style.display = 'none'; document.getElementById('camera-loading').style.display = 'flex'; initCamera(); }

function toggleFullscreen() {
    const container = document.getElementById('video-container');
    if (document.fullscreenElement) document.exitFullscreen();
    else container.requestFullscreen().catch(() => {});
}

function takeSnapshot() {
    Haptic.heavy();
    const source = videoEl.style.display !== 'none' ? videoEl : mjpegEl;
    const canvas = document.createElement('canvas');
    canvas.width = source.videoWidth || source.naturalWidth || 1280;
    canvas.height = source.videoHeight || source.naturalHeight || 720;
    canvas.getContext('2d').drawImage(source, 0, 0);
    document.getElementById('snapshot-preview').src = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('snapshot-modal').style.display = 'flex';
    Toast.success('Snapshot captured!');
}

function closeSnapshot() { document.getElementById('snapshot-modal').style.display = 'none'; }
function downloadSnapshot() {
    const link = document.createElement('a');
    link.href = document.getElementById('snapshot-preview').src;
    link.download = `reggie-snapshot-${Date.now()}.jpg`;
    link.click();
    Toast.success('Snapshot saved!');
    closeSnapshot();
}
</script>
{% endblock %}
