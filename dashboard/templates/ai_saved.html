{% extends "base.html" %}

{% block title %}Saved - AI Studio{% endblock %}
{% block page_title %}Saved Generations{% endblock %}
{% block page_subtitle %}Browse your saved images and prompts{% endblock %}

{% block content %}
<style>
    .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .history-item {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .history-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .history-image {
        aspect-ratio: 1;
        overflow: hidden;
        background: var(--bg-tertiary);
    }

    .history-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .history-info {
        padding: 12px;
    }

    .history-prompt {
        font-size: 0.9rem;
        color: var(--text-primary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .history-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 0.8rem;
    }

    .history-meta .badge {
        font-size: 0.75rem;
    }

    .filter-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .filter-bar input, .filter-bar select {
        padding: 10px 16px;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
    }

    .filter-bar input {
        flex: 1;
        min-width: 200px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>

<!-- Filter Bar -->
<div class="filter-bar">
    <input type="text" id="search-prompt" placeholder="Search prompts..." onkeyup="filterHistory()">
    <select id="filter-model" onchange="filterHistory()">
        <option value="">All Models</option>
        {% for model in models|default([]) %}
        <option value="{{ model.filename }}">{{ model.name }}</option>
        {% endfor %}
    </select>
    <select id="filter-favorite" onchange="filterHistory()">
        <option value="">All</option>
        <option value="1">Favorites Only</option>
    </select>
</div>

{% if generations %}
<div class="history-grid" id="history-grid">
    {% for gen in generations %}
    <div class="history-item" onclick="viewGeneration('{{ gen.id }}')" data-prompt="{{ gen.prompt|lower }}" data-model="{{ gen.model }}" data-favorite="{{ gen.favorite }}">
        <div class="history-image">
            {% if gen.thumbnail_path %}
            <img src="/api/ai/image/{{ gen.id }}/thumb" alt="Generated image">
            {% else %}
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                No preview
            </div>
            {% endif %}
        </div>
        <div class="history-info">
            <div class="history-prompt">{{ gen.prompt[:100] }}{% if gen.prompt|length > 100 %}...{% endif %}</div>
            <div class="history-meta">
                <span class="badge badge-secondary">{{ gen.model[:20] }}</span>
                <span class="badge">{{ gen.width }}x{{ gen.height }}</span>
                {% if gen.favorite %}
                <span class="badge badge-warning">Favorite</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M20.4 14.5L16 10 4 20"/>
    </svg>
    <h3>No generations yet</h3>
    <p>Start generating images to build your history</p>
    <a href="{{ url_for('ai_generate') }}" class="btn btn-primary" style="margin-top: 16px;">
        Create Your First Image
    </a>
</div>
{% endif %}

<!-- Detail Modal (hidden by default) -->
<div id="detail-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 40px; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 0 auto; background: var(--bg-card); border-radius: 16px; overflow: hidden;">
        <div id="modal-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterHistory() {
    const searchTerm = document.getElementById('search-prompt').value.toLowerCase();
    const modelFilter = document.getElementById('filter-model').value;
    const favFilter = document.getElementById('filter-favorite').value;

    document.querySelectorAll('.history-item').forEach(item => {
        const prompt = item.dataset.prompt;
        const model = item.dataset.model;
        const favorite = item.dataset.favorite;

        let show = true;

        if (searchTerm && !prompt.includes(searchTerm)) show = false;
        if (modelFilter && model !== modelFilter) show = false;
        if (favFilter && favorite !== favFilter) show = false;

        item.style.display = show ? 'block' : 'none';
    });
}

async function viewGeneration(id) {
    // TODO: Load full generation details in modal
    window.location.href = `/ai/generate?load=${id}`;
}

// Close modal on click outside
document.getElementById('detail-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'detail-modal') {
        e.target.style.display = 'none';
    }
});
</script>
{% endblock %}
