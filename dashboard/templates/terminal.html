{% extends "base.html" %}

{% block title %}Terminal{% endblock %}

{% block content %}
<div class="terminal-container">
    <div class="terminal-tabs-bar">
        <div class="terminal-tabs" id="terminal-tabs">
            <!-- Tabs inserted here by JS -->
        </div>
        <button class="tab-new-btn" onclick="createNewTab()" title="New Terminal (Ctrl+T)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>
    </div>
    <div class="terminal-instances" id="terminal-instances">
        <!-- Terminal iframes inserted here by JS -->
    </div>
</div>

<!-- Right-click context menu -->
<div class="tab-context-menu" id="tab-context-menu">
    <div class="context-item" onclick="renameTab()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
        </svg>
        Rename
    </div>
    <div class="context-item" onclick="reconnectTab()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Reconnect
    </div>
    <div class="context-divider"></div>
    <div class="context-item context-danger" onclick="closeTab()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Close
    </div>
</div>

<!-- Rename modal -->
<div class="rename-modal" id="rename-modal">
    <div class="rename-dialog">
        <h3>Rename Tab</h3>
        <input type="text" id="rename-input" placeholder="Terminal name..." maxlength="20">
        <div class="rename-actions">
            <button class="btn btn-secondary" onclick="cancelRename()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmRename()">Rename</button>
        </div>
    </div>
</div>

<style>
.terminal-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
    min-height: 400px;
    background: #122637;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #1e3a4c;
}

/* Tab Bar */
.terminal-tabs-bar {
    display: flex;
    align-items: center;
    background: #0a1820;
    border-bottom: 1px solid #1e3a4c;
    padding: 0;
    min-height: 40px;
    flex-shrink: 0;
}

.terminal-tabs {
    display: flex;
    flex: 1;
    overflow-x: auto;
    scrollbar-width: none;
    cursor: default;
    min-height: 40px;
}

.terminal-tabs::-webkit-scrollbar {
    display: none;
}

/* Individual Tab */
.terminal-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: transparent;
    border: none;
    border-right: 1px solid #1e3a4c;
    color: #7a9bb3;
    font-size: 13px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    min-width: 100px;
    max-width: 180px;
    position: relative;
}

.terminal-tab:hover {
    background: #122637;
    color: #b8d4e8;
}

.terminal-tab.active {
    background: #122637;
    color: #ffffff;
    border-bottom: 2px solid #f0cb09;
    margin-bottom: -1px;
}

.terminal-tab .tab-icon {
    width: 14px;
    height: 14px;
    opacity: 0.6;
}

.terminal-tab.active .tab-icon {
    opacity: 1;
    color: #f0cb09;
}

.terminal-tab .tab-name {
    flex: 1;
    text-overflow: ellipsis;
    overflow: hidden;
    text-align: left;
}

.terminal-tab .tab-close {
    width: 16px;
    height: 16px;
    padding: 2px;
    border-radius: 4px;
    opacity: 0;
    transition: all 0.15s ease;
    color: #888;
}

.terminal-tab:hover .tab-close {
    opacity: 1;
}

.terminal-tab .tab-close:hover {
    background: #ff4444;
    color: white;
}

/* New Tab Button */
.tab-new-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    margin: 2px 8px;
    background: transparent;
    border: 1px solid #1e3a4c;
    border-radius: 6px;
    color: #7a9bb3;
    cursor: pointer;
    transition: all 0.15s ease;
    flex-shrink: 0;
}

.tab-new-btn:hover {
    background: #f0cb09;
    border-color: #f0cb09;
    color: #122637;
}

.tab-new-btn svg {
    width: 16px;
    height: 16px;
}

/* Terminal Instances Container */
.terminal-instances {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.terminal-instance {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background: #122637;
}

.terminal-instance.active {
    display: block;
}

.terminal-instance iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #122637;
}

/* Context Menu */
.tab-context-menu {
    position: fixed;
    background: #0a1820;
    border: 1px solid #1e3a4c;
    border-radius: 8px;
    padding: 6px 0;
    min-width: 160px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
}

.tab-context-menu.visible {
    display: block;
}

.context-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px;
    color: #b8d4e8;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.1s ease;
}

.context-item:hover {
    background: #122637;
}

.context-item svg {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.context-item.context-danger {
    color: #ff6b6b;
}

.context-item.context-danger:hover {
    background: rgba(255, 107, 107, 0.15);
}

.context-divider {
    height: 1px;
    background: #1e3a4c;
    margin: 6px 0;
}

/* Rename Modal */
.rename-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

.rename-modal.visible {
    display: flex;
}

.rename-dialog {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
}

.rename-dialog h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--text-primary);
}

.rename-dialog input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
    margin-bottom: 16px;
    box-sizing: border-box;
}

.rename-dialog input:focus {
    outline: none;
    border-color: var(--accent);
}

.rename-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .terminal-container {
        height: calc(100vh - 80px);
        border-radius: 0;
    }

    .terminal-tab {
        min-width: 80px;
        padding: 8px 10px;
    }

    .terminal-tab .tab-name {
        max-width: 60px;
    }
}
</style>

<script>
// Terminal Manager using iframes
const TerminalManager = {
    tabs: [],
    activeTabId: null,
    contextTabId: null,
    tabCounter: 0,

    init() {
        // Create first tab
        this.createTab();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+T: New tab
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                this.createTab();
            }
            // Ctrl+W: Close tab
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                if (this.tabs.length > 1) {
                    this.closeTabById(this.activeTabId);
                }
            }
            // Ctrl+Tab: Next tab
            if (e.ctrlKey && e.key === 'Tab') {
                e.preventDefault();
                this.nextTab();
            }
            // Escape: Close modals
            if (e.key === 'Escape') {
                this.hideRenameModal();
                this.hideContextMenu();
            }
            // Enter: Confirm rename
            if (e.key === 'Enter' && document.getElementById('rename-modal').classList.contains('visible')) {
                confirmRename();
            }
        });

        // Close context menu on click outside
        document.addEventListener('click', () => this.hideContextMenu());

        // Double-click on empty tab bar area creates new tab
        document.getElementById('terminal-tabs').addEventListener('dblclick', (e) => {
            if (e.target.id === 'terminal-tabs' || e.target.classList.contains('terminal-tabs')) {
                this.createTab();
            }
        });
    },

    getTtydUrl() {
        const host = window.location.hostname;
        return `http://${host}:7681`;
    },

    createTab(name = null) {
        const id = ++this.tabCounter;
        const tabName = name || `Terminal ${id}`;

        const tab = {
            id,
            name: tabName
        };

        this.tabs.push(tab);

        // Create tab element
        const tabEl = document.createElement('div');
        tabEl.className = 'terminal-tab';
        tabEl.dataset.id = id;
        tabEl.innerHTML = `
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"/>
                <line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            <span class="tab-name">${tabName}</span>
            <svg class="tab-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" onclick="event.stopPropagation(); TerminalManager.closeTabById(${id})">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        `;

        tabEl.addEventListener('click', () => this.activateTab(id));
        tabEl.addEventListener('dblclick', () => this.showRenameModal(id));
        tabEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            this.showContextMenu(e, id);
        });

        document.getElementById('terminal-tabs').appendChild(tabEl);

        // Create terminal container with iframe
        const container = document.createElement('div');
        container.className = 'terminal-instance';
        container.dataset.id = id;

        const iframe = document.createElement('iframe');
        iframe.src = this.getTtydUrl();
        container.appendChild(iframe);

        document.getElementById('terminal-instances').appendChild(container);

        // Activate the new tab
        this.activateTab(id);

        return tab;
    },

    activateTab(id) {
        // Update tab elements
        document.querySelectorAll('.terminal-tab').forEach(el => {
            el.classList.toggle('active', parseInt(el.dataset.id) === id);
        });

        // Update terminal visibility
        document.querySelectorAll('.terminal-instance').forEach(el => {
            el.classList.toggle('active', parseInt(el.dataset.id) === id);
        });

        this.activeTabId = id;

        // Focus the iframe
        const container = document.querySelector(`.terminal-instance[data-id="${id}"]`);
        if (container) {
            const iframe = container.querySelector('iframe');
            if (iframe) {
                setTimeout(() => iframe.focus(), 50);
            }
        }
    },

    closeTabById(id) {
        if (this.tabs.length <= 1) return;

        const index = this.tabs.findIndex(t => t.id === id);
        if (index === -1) return;

        // Remove tab data
        this.tabs.splice(index, 1);

        // Remove DOM elements
        document.querySelector(`.terminal-tab[data-id="${id}"]`)?.remove();
        document.querySelector(`.terminal-instance[data-id="${id}"]`)?.remove();

        // Activate another tab if this was active
        if (this.activeTabId === id) {
            const newIndex = Math.min(index, this.tabs.length - 1);
            this.activateTab(this.tabs[newIndex].id);
        }
    },

    nextTab() {
        const currentIndex = this.tabs.findIndex(t => t.id === this.activeTabId);
        const nextIndex = (currentIndex + 1) % this.tabs.length;
        this.activateTab(this.tabs[nextIndex].id);
    },

    renameTab(id, newName) {
        const tab = this.tabs.find(t => t.id === id);
        if (tab) {
            tab.name = newName;
            const tabEl = document.querySelector(`.terminal-tab[data-id="${id}"] .tab-name`);
            if (tabEl) {
                tabEl.textContent = newName;
            }
        }
    },

    reconnectTab(id) {
        const container = document.querySelector(`.terminal-instance[data-id="${id}"]`);
        if (container) {
            const iframe = container.querySelector('iframe');
            if (iframe) {
                iframe.src = iframe.src;
            }
        }
    },

    showContextMenu(e, id) {
        this.contextTabId = id;
        const menu = document.getElementById('tab-context-menu');
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
        menu.classList.add('visible');
    },

    hideContextMenu() {
        document.getElementById('tab-context-menu').classList.remove('visible');
    },

    showRenameModal(id) {
        this.contextTabId = id;
        const tab = this.tabs.find(t => t.id === id);
        const input = document.getElementById('rename-input');
        input.value = tab ? tab.name : '';
        document.getElementById('rename-modal').classList.add('visible');
        setTimeout(() => {
            input.focus();
            input.select();
        }, 100);
    },

    hideRenameModal() {
        document.getElementById('rename-modal').classList.remove('visible');
    }
};

// Global functions for onclick handlers
function createNewTab() {
    TerminalManager.createTab();
}

function renameTab() {
    TerminalManager.hideContextMenu();
    TerminalManager.showRenameModal(TerminalManager.contextTabId);
}

function confirmRename() {
    const input = document.getElementById('rename-input');
    if (input.value.trim()) {
        TerminalManager.renameTab(TerminalManager.contextTabId, input.value.trim());
    }
    TerminalManager.hideRenameModal();
}

function cancelRename() {
    TerminalManager.hideRenameModal();
}

function reconnectTab() {
    TerminalManager.reconnectTab(TerminalManager.contextTabId);
    TerminalManager.hideContextMenu();
}

function closeTab() {
    TerminalManager.closeTabById(TerminalManager.contextTabId);
    TerminalManager.hideContextMenu();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    TerminalManager.init();
});
</script>
{% endblock %}
