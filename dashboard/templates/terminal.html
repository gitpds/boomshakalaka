{% extends "base.html" %}

{% block title %}Terminal{% endblock %}
{% block sidebar_title %}Terminal{% endblock %}

{% block content %}
<div class="terminal-container">
    <div class="terminal-tabs-bar">
        <div class="terminal-tabs" id="terminal-tabs">
            <!-- Tabs populated by JavaScript -->
        </div>
        <button class="tab-new-btn" onclick="TerminalManager.createWindow()" title="New Terminal (Ctrl+T)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>
    </div>
    <div class="terminal-content">
        <iframe id="terminal-iframe" src=""></iframe>
    </div>
</div>

<!-- Right-click context menu -->
<div class="tab-context-menu" id="tab-context-menu">
    <div class="context-item" onclick="TerminalManager.showRenameModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
        </svg>
        Rename
    </div>
    <div class="context-item" onclick="TerminalManager.reconnect()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Reconnect
    </div>
    <div class="context-divider"></div>
    <div class="context-item context-danger" onclick="TerminalManager.closeWindow(TerminalManager.contextWindowId)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Close
    </div>
</div>

<!-- Rename modal -->
<div class="rename-modal" id="rename-modal">
    <div class="rename-dialog">
        <h3>Rename Tab</h3>
        <input type="text" id="rename-input" placeholder="Terminal name..." maxlength="20">
        <div class="rename-actions">
            <button class="btn btn-secondary" onclick="TerminalManager.hideRenameModal()">Cancel</button>
            <button class="btn btn-primary" onclick="TerminalManager.confirmRename()">Rename</button>
        </div>
    </div>
</div>

<style>
.terminal-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
    min-height: 400px;
    background: var(--bg-primary);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

/* Tab Bar */
.terminal-tabs-bar {
    display: flex;
    align-items: center;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 0;
    min-height: 40px;
    flex-shrink: 0;
}

.terminal-tabs {
    display: flex;
    flex: 1;
    overflow-x: auto;
    scrollbar-width: none;
    cursor: default;
    min-height: 40px;
}

.terminal-tabs::-webkit-scrollbar {
    display: none;
}

/* Individual Tab */
.terminal-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: transparent;
    border: none;
    border-right: 1px solid var(--border-color);
    color: var(--text-muted);
    font-size: 13px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    min-width: 100px;
    max-width: 180px;
    position: relative;
}

.terminal-tab:hover {
    background: var(--bg-primary);
    color: var(--text-secondary);
}

.terminal-tab.active {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent);
    margin-bottom: -1px;
}

.terminal-tab .tab-icon {
    width: 14px;
    height: 14px;
    opacity: 0.6;
}

.terminal-tab.active .tab-icon {
    opacity: 1;
    color: var(--accent);
}

.terminal-tab .tab-name {
    flex: 1;
    text-overflow: ellipsis;
    overflow: hidden;
    text-align: left;
}

.terminal-tab .tab-close {
    width: 16px;
    height: 16px;
    padding: 2px;
    border-radius: 4px;
    opacity: 0;
    transition: all 0.15s ease;
    color: var(--text-muted);
}

.terminal-tab:hover .tab-close {
    opacity: 1;
}

.terminal-tab .tab-close:hover {
    background: var(--error);
    color: white;
}

/* New Tab Button */
.tab-new-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    margin: 2px 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s ease;
    flex-shrink: 0;
}

.tab-new-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg-primary);
}

.tab-new-btn svg {
    width: 16px;
    height: 16px;
}

/* Terminal Content - Single iframe */
.terminal-content {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.terminal-content iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: var(--bg-primary);
}

/* Context Menu */
.tab-context-menu {
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 6px 0;
    min-width: 160px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
}

.tab-context-menu.visible {
    display: block;
}

.context-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px;
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: background 0.1s ease;
}

.context-item:hover {
    background: var(--bg-primary);
}

.context-item svg {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.context-item.context-danger {
    color: var(--error);
}

.context-item.context-danger:hover {
    background: var(--error-bg);
}

.context-divider {
    height: 1px;
    background: var(--border-color);
    margin: 6px 0;
}

/* Rename Modal */
.rename-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

.rename-modal.visible {
    display: flex;
}

.rename-dialog {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
}

.rename-dialog h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--text-primary);
}

.rename-dialog input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
    margin-bottom: 16px;
    box-sizing: border-box;
}

.rename-dialog input:focus {
    outline: none;
    border-color: var(--accent);
}

.rename-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .terminal-container {
        height: calc(100vh - 80px);
        border-radius: 0;
    }

    .terminal-tab {
        min-width: 80px;
        padding: 8px 10px;
    }

    .terminal-tab .tab-name {
        max-width: 60px;
    }
}
</style>

<script>
// Persistent Terminal Manager - backed by tmux sessions
const TerminalManager = {
    windows: [],
    activeWindowId: null,
    contextWindowId: null,

    getTtydUrl() {
        const host = window.location.hostname;
        return `http://${host}:7681`;
    },

    async init() {
        // Load existing windows from backend
        await this.loadWindows();

        // If no windows exist, the first one will be created by tmux/ttyd automatically
        // Just need to load the iframe
        const iframe = document.getElementById('terminal-iframe');
        iframe.src = this.getTtydUrl();

        this.setupKeyboardShortcuts();
        this.setupContextMenu();
    },

    async loadWindows() {
        try {
            const resp = await fetch('/api/terminal/windows');
            const data = await resp.json();
            this.windows = data.windows || [];

            // If we have windows, render them
            if (this.windows.length > 0) {
                this.renderTabs();
                // Set active window
                const active = this.windows.find(w => w.active);
                if (active) {
                    this.activeWindowId = active.id;
                } else {
                    this.activeWindowId = this.windows[0].id;
                }
                this.updateActiveTab();
            } else {
                // No windows yet - tmux will create window 0 when ttyd connects
                // We'll show a default tab
                this.windows = [{id: '0', name: 'Terminal 1', active: true}];
                this.activeWindowId = '0';
                this.renderTabs();

                // Save the initial window metadata
                await fetch('/api/terminal/windows/0', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: 'Terminal 1'})
                });
            }
        } catch (err) {
            console.error('Failed to load terminal windows:', err);
            // Fallback: show default tab
            this.windows = [{id: '0', name: 'Terminal 1', active: true}];
            this.activeWindowId = '0';
            this.renderTabs();
        }
    },

    async createWindow(name = null) {
        const windowName = name || `Terminal ${this.windows.length + 1}`;

        try {
            const resp = await fetch('/api/terminal/windows', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: windowName})
            });
            const data = await resp.json();

            if (data.error) {
                console.error(data.error);
                return;
            }

            this.windows.push({id: data.id, name: data.name, active: true});
            this.activeWindowId = data.id;
            this.renderTabs();
            this.updateActiveTab();
        } catch (err) {
            console.error('Failed to create window:', err);
        }
    },

    async selectWindow(windowId) {
        if (this.activeWindowId === windowId) return;

        try {
            await fetch(`/api/terminal/windows/${windowId}/select`, {method: 'POST'});
            this.activeWindowId = windowId;
            this.windows.forEach(w => w.active = (w.id === windowId));
            this.updateActiveTab();
        } catch (err) {
            console.error('Failed to select window:', err);
        }
    },

    async closeWindow(windowId) {
        if (this.windows.length <= 1) return;

        try {
            const resp = await fetch(`/api/terminal/windows/${windowId}`, {method: 'DELETE'});
            const data = await resp.json();

            if (data.error) {
                console.error(data.error);
                return;
            }

            // Remove from local state
            const index = this.windows.findIndex(w => w.id === windowId);
            this.windows.splice(index, 1);
            this.renderTabs();

            // Select adjacent window if we closed the active one
            if (this.activeWindowId === windowId) {
                const newIndex = Math.min(index, this.windows.length - 1);
                await this.selectWindow(this.windows[newIndex].id);
            }
        } catch (err) {
            console.error('Failed to close window:', err);
        }

        this.hideContextMenu();
    },

    async renameWindow(windowId, newName) {
        try {
            await fetch(`/api/terminal/windows/${windowId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: newName})
            });

            const win = this.windows.find(w => w.id === windowId);
            if (win) win.name = newName;
            this.renderTabs();
        } catch (err) {
            console.error('Failed to rename window:', err);
        }
    },

    renderTabs() {
        const container = document.getElementById('terminal-tabs');
        container.innerHTML = this.windows.map(w => `
            <div class="terminal-tab ${w.id === this.activeWindowId ? 'active' : ''}"
                 data-id="${w.id}">
                <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 17 10 11 4 5"/>
                    <line x1="12" y1="19" x2="20" y2="19"/>
                </svg>
                <span class="tab-name">${this.escapeHtml(w.name)}</span>
                <svg class="tab-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </div>
        `).join('');

        // Attach event listeners
        container.querySelectorAll('.terminal-tab').forEach(tab => {
            const id = tab.dataset.id;

            tab.addEventListener('click', (e) => {
                if (!e.target.closest('.tab-close')) {
                    this.selectWindow(id);
                }
            });

            tab.addEventListener('dblclick', () => {
                this.contextWindowId = id;
                this.showRenameModal();
            });

            tab.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                this.showContextMenu(e, id);
            });

            tab.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                this.closeWindow(id);
            });
        });
    },

    updateActiveTab() {
        document.querySelectorAll('.terminal-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.id === this.activeWindowId);
        });
    },

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    reconnect() {
        const iframe = document.getElementById('terminal-iframe');
        iframe.src = iframe.src;
        this.hideContextMenu();
    },

    // Context Menu
    showContextMenu(e, windowId) {
        this.contextWindowId = windowId;
        const menu = document.getElementById('tab-context-menu');
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
        menu.classList.add('visible');
    },

    hideContextMenu() {
        document.getElementById('tab-context-menu').classList.remove('visible');
    },

    // Rename Modal
    showRenameModal() {
        this.hideContextMenu();
        const win = this.windows.find(w => w.id === this.contextWindowId);
        const input = document.getElementById('rename-input');
        input.value = win ? win.name : '';
        document.getElementById('rename-modal').classList.add('visible');
        setTimeout(() => {
            input.focus();
            input.select();
        }, 100);
    },

    hideRenameModal() {
        document.getElementById('rename-modal').classList.remove('visible');
    },

    confirmRename() {
        const input = document.getElementById('rename-input');
        if (input.value.trim()) {
            this.renameWindow(this.contextWindowId, input.value.trim());
        }
        this.hideRenameModal();
    },

    // Keyboard Shortcuts
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl+T: New tab
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                this.createWindow();
            }
            // Ctrl+W: Close tab
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                if (this.windows.length > 1) {
                    this.closeWindow(this.activeWindowId);
                }
            }
            // Ctrl+Tab: Next tab
            if (e.ctrlKey && e.key === 'Tab') {
                e.preventDefault();
                this.nextTab();
            }
            // Escape: Close modals
            if (e.key === 'Escape') {
                this.hideRenameModal();
                this.hideContextMenu();
            }
            // Enter: Confirm rename
            if (e.key === 'Enter' && document.getElementById('rename-modal').classList.contains('visible')) {
                this.confirmRename();
            }
        });
    },

    setupContextMenu() {
        // Close context menu on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tab-context-menu')) {
                this.hideContextMenu();
            }
        });
    },

    nextTab() {
        const currentIndex = this.windows.findIndex(w => w.id === this.activeWindowId);
        const nextIndex = (currentIndex + 1) % this.windows.length;
        this.selectWindow(this.windows[nextIndex].id);
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    TerminalManager.init();
});
</script>
{% endblock %}
